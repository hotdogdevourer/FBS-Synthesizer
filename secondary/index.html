<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FSB4 Pyodide Synth GUI</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  textarea { width: 100%; height: 200px; font-family: monospace; font-size: 14px; }
  button { margin: 5px 0; }
</style>
</head>
<body>
<h2>FSB4 Pyodide Synthesizer (Simplified)</h2>

<label for="spec">Phoneme Spec (OVRLP format):</label>
<textarea id="spec">SIL 0.190 0.000 0.0
HH 0.080 0.012 115.0
EH 0.120 0.025 115.0</textarea>

<br>
<button id="parseBtn">Parse Spec</button>
<button id="renderBtn">Render Audio</button>
<audio id="player" controls></audio>

<p id="status">Status: Ready</p>

<script>
let pyodideReady = false;
let pyodide = null;

async function initPyodide() {
    pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/" });
    // Load your FSB4.py file
    const fsbPy = await (await fetch("FSB4.py")).text();
    pyodide.runPython(fsbPy);

    // Create a cache dict for rendered audio
    pyodide.runPython(`rendered_audio = None`);
    pyodideReady = true;
    document.getElementById("status").innerText = "Status: Pyodide loaded!";
}

initPyodide();

// Parse button
document.getElementById("parseBtn").addEventListener("click", async () => {
    if (!pyodideReady) return;
    const spec = document.getElementById("spec").value;
    try {
        pyodide.globals.set("spec_text", spec);
        pyodide.runPython(`
from js import spec_text
# Simple parse to specs
try:
    current_specs = fsb.parse_phoneme_spec(spec_text, fsb.VOICE_REGISTRY.current_voice)
    status_msg = f"âœ“ Parsed {len(current_specs)} phonemes"
except Exception as e:
    current_specs = []
    status_msg = f"ERROR parsing: {str(e)}"
        `);
        const status = pyodide.runPython("status_msg");
        document.getElementById("status").innerText = "Status: " + status;
    } catch (e) {
        console.error(e);
        document.getElementById("status").innerText = "Status: ERROR parsing spec";
    }
});

// Render button
document.getElementById("renderBtn").addEventListener("click", async () => {
    if (!pyodideReady) return;
    try {
        document.getElementById("status").innerText = "Status: Rendering audio...";
        await pyodide.runPythonAsync(`
import numpy as np
from js import Uint8Array

synth = fsb.FormantSynthesizer(fsb.VOICE_REGISTRY.current_voice, sample_rate=fsb.smp)
audio_buffer = synth.synthesize_from_specs(current_specs)
# Convert to WAV bytes
import io, wave
wav_io = io.BytesIO()
audio_int16 = np.clip(audio_buffer * 32767, -32768, 32767).astype(np.int16)
with wave.open(wav_io, 'wb') as wf:
    wf.setnchannels(1)
    wf.setsampwidth(2)
    wf.setframerate(fsb.smp)
    wf.writeframes(audio_int16.tobytes())
wav_bytes = wav_io.getvalue()
# Convert to JS Uint8Array for browser
rendered_audio = Uint8Array.new(wav_bytes)
        `);
        // Create blob and set audio src
        const wavBytes = pyodide.globals.get("rendered_audio");
        const blob = new Blob([wavBytes.to_py()], { type: "audio/wav" });
        const url = URL.createObjectURL(blob);
        const player = document.getElementById("player");
        player.src = url;
        player.play();
        document.getElementById("status").innerText = "Status: Audio rendered & playing!";
    } catch (e) {
        console.error(e);
        document.getElementById("status").innerText = "Status: ERROR rendering audio";
    }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>FSB4 Formant Synthesizer</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
    <h1>FSB4 Formant Synthesizer</h1>
    
    <div>
        <label for="textInput">Text Input:</label>
        <input type="text" id="textInput" value="hello world">
        <button onclick="synthesize()">Synthesize</button>
    </div>

    <div>
        <label for="phonemeInput">Phoneme Sequence:</label>
        <textarea id="phonemeInput" rows="4" cols="50"># PHONEME  DUR    OVRLP  P0 [P1 P2 ...]
HH   0.100  0.018  115.0
EH   0.100  0.018  115.0
L    0.100  0.008  0.0
AO   0.140  0.018  115.0
OW   0.140  0.018  115.0</textarea>
    </div>

    <div>
        <label for="voiceSelect">Voice:</label>
        <select id="voiceSelect">
            <option value="Default">Default</option>
        </select>
    </div>

    <div>
        <audio id="player" controls></audio>
    </div>

    <div>
        <button onclick="savePhonemes()">Save Phonemes</button>
        <button onclick="loadPhonemes()">Load Phonemes</button>
        <input type="file" id="fileInput" style="display:none;" onchange="handleFile(event)">
    </div>

    <div id="output"></div>

    <script>
        let pyodide;
        
        async function main() {
            pyodide = await loadPyodide();
            pyodide.runPython(`
                import micropip
                await micropip.install(['numpy', 'scipy'])
            `);
            
            // Load your FSB4.py code
            const fsb4Code = `// Your FSB4.py code here (replaced placeholder below)`;
            pyodide.runPython(fsb4Code);
            
            document.getElementById("output").innerHTML = "FSB4 loaded successfully!";
        }
        
        function synthesize() {
            const text = document.getElementById("textInput").value;
            const phonemeSpec = document.getElementById("phonemeInput").value;
            const voiceName = document.getElementById("voiceSelect").value;

            try {
                const result = pyodide.runPython(`
                    import io
                    import wave
                    import base64
                    
                    # Set current voice
                    VOICE_REGISTRY.set_current_voice("${voiceName}")
                    
                    # Process text or phoneme spec
                    if "${phonemeSpec}".startswith("#"):
                        specs = parse_phoneme_spec("${phonemeSpec}", VOICE_REGISTRY.current_voice)
                    else:
                        phonemes = text_to_phonemes("${text}")
                        specs = phonemes_to_spec(phonemes, VOICE_REGISTRY.current_voice)
                    
                    # Synthesize audio
                    synth = FormantSynthesizer(VOICE_REGISTRY.current_voice)
                    audio = synth.synthesize_from_specs(specs)
                    
                    # Save to virtual wav file
                    wav_buffer = io.BytesIO()
                    save_wav(wav_buffer, audio)
                    wav_buffer.seek(0)
                    
                    # Encode to base64
                    base64.b64encode(wav_buffer.getvalue()).decode()
                `);
                
                const audio = document.getElementById("player");
                audio.src = `data:audio/wav;base64,${result}`;
                audio.play();
                
                // Update phoneme display
                const readableSpecs = pyodide.runPython(`
                    specs_to_readable(specs)
                `);
                document.getElementById("phonemeInput").value = readableSpecs;
                
            } catch (error) {
                document.getElementById("output").innerHTML = "Error: " + error.message;
            }
        }
        
        function savePhonemes() {
            const specs = pyodide.runPython(`
                import io
                import base64
                
                # Parse current phoneme spec
                specs = parse_phoneme_spec("${document.getElementById("phonemeInput").value}", VOICE_REGISTRY.current_voice)
                
                # Save to buffer
                buffer = io.BytesIO()
                save_parameterized_phonemes(buffer, specs)
                
                # Return base64 encoded data
                base64.b64encode(buffer.getvalue()).decode()
            `);
            
            // Create download link
            const blob = new Blob([Uint8Array.from(atob(specs), c => c.charCodeAt(0))], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'phonemes.phx';
            a.click();
        }
        
        function loadPhonemes() {
            document.getElementById("fileInput").click();
        }
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const bytes = new Uint8Array(e.target.result);
                const base64Data = btoa(String.fromCharCode.apply(null, bytes));
                
                try {
                    const specs = pyodide.runPython(`
                        import io
                        import base64
                        
                        # Decode base64 data
                        data = base64.b64decode("${base64Data}")
                        buffer = io.BytesIO(data)
                        
                        # Load specs
                        specs = load_parameterized_phonemes(buffer)
                        
                        # Convert to readable format
                        specs_to_readable(specs)
                    `);
                    
                    document.getElementById("phonemeInput").value = specs;
                    document.getElementById("output").innerHTML = "Phoneme file loaded successfully!";
                } catch (error) {
                    document.getElementById("output").innerHTML = "Error loading phoneme file: " + error.message;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Initialize Pyodide when page loads
        main();
    </script>
</body>
</html>
